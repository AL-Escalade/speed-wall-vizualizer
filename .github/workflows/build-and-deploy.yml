name: Build and deploy

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: write
  pull-requests: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.ref }}
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'
          cache: 'npm'

      - name: Fix Dependabot lockfile
        if: github.actor == 'dependabot[bot]'
        run: |
          echo "Dependabot PR detected, updating package-lock.json..."
          npm install --package-lock-only

      - name: Commit lockfile changes
        if: github.actor == 'dependabot[bot]'
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: 'chore: update package-lock.json for workspace dependencies'
          file_pattern: 'package-lock.json'
          commit_user_name: 'github-actions[bot]'
          commit_user_email: 'github-actions[bot]@users.noreply.github.com'

      - name: Install dependencies
        run: npm ci

      - name: Lint
        run: npm run lint

      - name: Build core package
        run: npm run build:core

      - name: Run tests with coverage
        run: npm run test:coverage

      - name: Copy coverage file to root
        run: cp coverage/cobertura-coverage.xml cobertura-coverage.xml

      - name: Code Coverage Report
        uses: clearlyip/code-coverage-report-action@v5
        id: code_coverage_report
        if: github.event_name == 'pull_request'
        with:
          filename: 'cobertura-coverage.xml'
          fail_on_negative_difference: true
          artifact_download_workflow_names: 'Build and deploy'
          artifact_name: 'code-coverage-%name%'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Add coverage PR comment
        uses: marocchino/sticky-pull-request-comment@v2
        if: github.event_name == 'pull_request' && steps.code_coverage_report.outputs.file != ''
        with:
          recreate: true
          path: ${{ steps.code_coverage_report.outputs.file }}

      - name: Set coverage artifact name
        id: coverage_artifact
        run: |
          BRANCH_NAME="${{ github.event.pull_request.head.ref || github.ref_name }}"
          SAFE_NAME=$(echo "$BRANCH_NAME" | tr '/' '-')
          echo "name=code-coverage-$SAFE_NAME" >> $GITHUB_OUTPUT

      - name: Upload coverage artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.coverage_artifact.outputs.name }}
          path: cobertura-coverage.xml
          retention-days: 30

      - name: Build web application
        run: npm run build:web

      - name: Upload build artifacts
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        uses: actions/upload-artifact@v4
        with:
          name: web-dist
          path: packages/web/dist
          retention-days: 1
          include-hidden-files: true

  deploy:
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
      - uses: actions/checkout@v4

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: web-dist
          path: dist

      - name: SFTP Deploy
        uses: milanmk/actions-file-deployer@master
        with:
          remote-protocol: sftp
          remote-host: ftp.cluster015.hosting.ovh.net
          remote-user: ${{ secrets.PROD_FTP_USERNAME }}
          remote-password: ${{ secrets.PROD_FTP_PASSWORD }}
          remote-path: /home/alescala/configurateur-voies-vitesse
          local-path: dist/
          sync: full
